{% extends "core/base.html" %}
{% load static %}

{% block title %}Inventario ¬∑ Pharmacontrol{% endblock %}

{% block head_extra %}
  {# Si necesitas algo extra, como Chart.js, va aqu√≠ #}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="appbar">
  <div class="crumbs">Pharmacontrol / <b>Inventario</b></div>
  <div class="spacer"></div>

  <div class="appbar-search position-relative" style="min-width:340px;">
    <i class="bi bi-search position-absolute" style="left:10px;top:50%;transform:translateY(-50%);pointer-events:none;"></i>
    <input
      id="global-search"
      type="search"
      class="form-control form-control-sm ps-4"
      placeholder="Buscar medicamentos, proveedores, pedidos o ventas‚Ä¶"
      aria-label="Buscar en el inventario"
      role="combobox"
      aria-expanded="false"
      aria-autocomplete="list"
      aria-controls="global-results"
      autocomplete="off"
      data-url="{% url 'search_inventory' %}"
    >
    <div
      id="global-results"
      role="listbox"
      class="list-group shadow-sm"
      style="position:absolute;top:100%;left:0;right:0;z-index:1050;display:none;max-height:360px;overflow:auto;border-radius:0.75rem;"
    ></div>
  </div>

  <div class="user">
    <div class="avatar"></div>
    <span class="text-muted-2">Sesi√≥n activa</span>
  </div>
</div>


  <!-- Encabezado -->
  <div class="page-header">
    <div>
      <div class="title">Inventario de Medicamentos</div>
      <div class="subtitle">Consulta, crea y gestiona el stock de tu farmacia.</div>
    </div>

    <!-- Filtro por stock -->
    <form method="get" class="filters" id="filtro-form">
      <select class="form-select form-select-sm" name="filtro" id="filtro-select">
        <option value="all"
          {% if request.GET.filtro == "all" or not request.GET.filtro %}selected{% endif %}>
          Todos
        </option>
        <option value="stock"
          {% if request.GET.filtro == "stock" %}selected{% endif %}>
          Con stock
        </option>
        <option value="sin_stock"
          {% if request.GET.filtro == "sin_stock" %}selected{% endif %}>
          Sin stock
        </option>
        <option value="caducar"
          {% if request.GET.filtro == "caducar" %}selected{% endif %}>
          Pr√≥ximos a caducar
        </option>
      </select>
    </form>
  </div>

  <!-- KPIs -->
  <div class="kpi-grid">
    <div class="kpi badge-up">
      <div class="kpi-label">Total Medicamentos</div>
      <div class="kpi-value">{{ total_medicamentos|default:"0" }}</div>
      <div class="kpi-trend">Cat√°logo operativo</div>
    </div>
    <div class="kpi badge-warn">
      <div class="kpi-label">Por Caducar</div>
      <div class="kpi-value">{{ por_caducar|default:"0" }}</div>
      <div class="kpi-trend">Revisar en pr√≥ximos 30-90 d√≠as</div>
    </div>
    <div class="kpi badge-down">
      <div class="kpi-label">Stock Cr√≠tico</div>
      <div class="kpi-value">{{ stock_critico|default:"0" }}</div>
      <div class="kpi-trend">Reponer pronto</div>
    </div>
    <div class="kpi">
      <div class="kpi-label">Medicamentos Agotados</div>
      <div class="kpi-value">{{ medicamento_agotado|default:"0" }}</div>
      <div class="kpi-trend">Pedidos pendientes: {{ pedidos_pendientes|default:"0" }}</div>
    </div>
  </div>

  <!-- Tabla + Crear -->
  <div class="table-card">
    <div class="table-toolbar">
      <div class="actions">
        <button type="button" class="btn-brand btn-sm" data-bs-toggle="modal" data-bs-target="#crearMedicamentoModal">
          <i class="bi bi-plus-lg"></i> Nuevo medicamento
        </button>
      </div>
    </div>

    <!-- Paginaci√≥n superior -->
    {% if page_obj %}
<nav aria-label="Paginaci√≥n inventario" class="d-flex justify-content-center mt-3">
  <ul class="pagination pagination-sm">

    {# Bot√≥n ¬´ anterior #}
    {% if page_obj.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?page={{ page_obj.previous_page_number }}">&laquo;</a>
      </li>
    {% else %}
      <li class="page-item disabled">
        <span class="page-link">&laquo;</span>
      </li>
    {% endif %}

    {# N√∫meros de p√°gina #}
    {% for num in page_obj.paginator.page_range %}
      <li class="page-item {% if page_obj.number == num %}active{% endif %}">
        <a class="page-link" href="?page={{ num }}">{{ num }}</a>
      </li>
    {% endfor %}

    {# Bot√≥n ¬ª siguiente #}
    {% if page_obj.has_next %}
      <li class="page-item">
        <a class="page-link" href="?page={{ page_obj.next_page_number }}">&raquo;</a>
      </li>
    {% else %}
      <li class="page-item disabled">
        <span class="page-link">&raquo;</span>
      </li>
    {% endif %}

  </ul>
</nav>

    {% endif %}

    {% if inventory %}
      <div class="table-responsive">
        <table id="tabla-meds" class="table table-striped table-bordered align-middle">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Lote</th>
              <th>Caducidad</th>
              <th>Stock</th>
              <th>Precio</th>
              <th>Proveedor</th>
              <th>Categor√≠a</th>
              <th style="width:120px">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for medicamento in inventory %}
              <tr>
                <td>{{ medicamento.nombre }}</td>
                <td>{{ medicamento.lote }}</td>
                <td>{{ medicamento.caducidad }}</td>
                <td>
                  {% if medicamento.stock|default:0 <= 0 %}
                    <span class="chip danger">Sin stock</span>
                  {% elif medicamento.stock < 10 %}
                    <span class="chip warn">Bajo ({{ medicamento.stock }})</span>
                  {% else %}
                    <span class="chip ok">{{ medicamento.stock }}</span>
                  {% endif %}
                </td>
                <td>${{ medicamento.precio|floatformat:2 }}</td>
                <td><span class="badge-soft">{{ medicamento.proveedor.nombre }}</span></td>
                <td>{{ medicamento.categoria.nombre }}</td>
                <td class="text-nowrap">
                  <a href="{% url 'detalle_medicamento' medicamento.id %}" class="btn btn-sm btn-ghost" title="Ver">
                    <i class="bi bi-eye"></i>
                  </a>
                  <a href="{% url 'edit_medicamento' medicamento.id %}" class="btn btn-sm btn-ghost" title="Editar">
                    <i class="bi bi-pencil"></i>
                  </a>
                  <form action="{% url 'eliminar_medicamento' medicamento.id %}" method="post" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-ghost text-danger" title="Eliminar"
                            onclick="return confirm('¬øSeguro que quieres eliminar este medicamento?');">
                      <i class="bi bi-trash"></i>
                    </button>
                  </form>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Paginaci√≥n inferior -->
      {% if page_obj %}
      <nav aria-label="Page navigation" class="mt-3">
        <ul class="pagination justify-content-center">
          {% if page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link"
                 href="?page={{ page_obj.previous_page_number }}{% if request.GET.filtro %}&filtro={{ request.GET.filtro }}{% endif %}">
                &laquo;
              </a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
          {% endif %}

          {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
              <li class="page-item active"><span class="page-link">{{ num }}</span></li>
            {% else %}
              <li class="page-item">
                <a class="page-link"
                   href="?page={{ num }}{% if request.GET.filtro %}&filtro={{ request.GET.filtro }}{% endif %}">
                  {{ num }}
                </a>
              </li>
            {% endif %}
          {% endfor %}

          {% if page_obj.has_next %}
            <li class="page-item">
              <a class="page-link"
                 href="?page={{ page_obj.next_page_number }}{% if request.GET.filtro %}&filtro={{ request.GET.filtro }}{% endif %}">
                &raquo;
              </a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
          {% endif %}
        </ul>
      </nav>
      {% endif %}
    {% else %}
      <div class="empty">
        <div class="icon">üíä</div>
        <div>No hay medicamentos en el inventario</div>
        <div class="text-muted">Crea tu primer medicamento con el bot√≥n ‚ÄúNuevo medicamento‚Äù.</div>
      </div>
    {% endif %}
  </div>
</div>

<!-- Modal crear (puede ir aqu√≠ o en base si se usa global) -->
<!-- Modal crear medicamento -->
<div class="modal fade" id="crearMedicamentoModal" tabindex="-1"
     aria-labelledby="crearMedicamentoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <form method="post" action="{% url 'create_medicamento' %}" autocomplete="off">
        {% csrf_token %}

        <!-- Header -->
        <div class="modal-header border-0 pb-0">
          <div>
            <h5 class="modal-title fw-semibold" id="crearMedicamentoModalLabel">
              Nuevo medicamento
            </h5>
            <p class="text-muted small mb-0">
              Completa la informaci√≥n b√°sica para agregarlo al inventario.
            </p>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>

        <!-- Body -->
        <div class="modal-body pt-3">
          <p class="text-muted small mb-3">
            Los campos marcados con <span class="text-danger">*</span> son obligatorios.
          </p>

          <div class="row g-3">
            <!-- Nombre -->
            <div class="col-md-8">
              <label class="form-label small fw-semibold">
                Nombre del medicamento <span class="text-danger">*</span>
              </label>
              <input type="text"
                     name="nombre"
                     class="form-control"
                     placeholder="Ej. PARACETAMOL 500 MG TAB"
                     required>
            </div>

            <!-- Lote -->
            <div class="col-md-4">
              <label class="form-label small fw-semibold">
                Lote <span class="text-danger">*</span>
              </label>
              <input type="text"
                     name="lote"
                     class="form-control"
                     placeholder="Ej. 650240036415"
                     required>
            </div>

            <!-- Caducidad con calendario -->
            <div class="col-md-4">
              <label class="form-label small fw-semibold">
                Fecha de caducidad <span class="text-danger">*</span>
              </label>
              <div class="input-group">
                <span class="input-group-text">
                  <i class="bi bi-calendar-event"></i>
                </span>
                <input type="date"
                       name="caducidad"
                       class="form-control"
                       required>
              </div>
            </div>

            <!-- Stock -->
            <div class="col-md-4">
              <label class="form-label small fw-semibold">
                Stock inicial <span class="text-danger">*</span>
              </label>
              <input type="number"
                     name="stock"
                     min="0"
                     class="form-control"
                     placeholder="Cantidad en piezas"
                     required>
            </div>

            <!-- Precio -->
            <div class="col-md-4">
              <label class="form-label small fw-semibold">
                Precio unitario <span class="text-danger">*</span>
              </label>
              <div class="input-group">
                <span class="input-group-text">$</span>
                <input type="number"
                       name="precio"
                       min="0"
                       step="0.01"
                       class="form-control"
                       placeholder="0.00"
                       required>
              </div>
            </div>

            <!-- Proveedor (con filtro por nombre) -->
            <div class="col-md-6">
              <label class="form-label small fw-semibold">
                Proveedor <span class="text-danger">*</span>
              </label>
              <input type="text"
                     id="buscar-proveedor"
                     class="form-control form-control-sm mb-1"
                     placeholder="Buscar proveedor por nombre‚Ä¶">
              <select class="form-select"
                      name="proveedor_id"
                      id="proveedor-select"
                      required>
                <option value="" disabled selected>Selecciona un proveedor</option>
                {% for prov in proveedores %}
                  <option value="{{ prov.id }}">{{ prov.nombre }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- Categor√≠a (con filtro por nombre) -->
            <div class="col-md-6">
              <label class="form-label small fw-semibold">
                Categor√≠a <span class="text-danger">*</span>
              </label>
              <input type="text"
                     id="buscar-categoria"
                     class="form-control form-control-sm mb-1"
                     placeholder="Buscar categor√≠a por nombre‚Ä¶">
              <select class="form-select"
                      name="categoria_id"
                      id="categoria-select"
                      required>
                <option value="" disabled selected>Selecciona una categor√≠a</option>
                {% for cat in categorias %}
                  <option value="{{ cat.id }}">{{ cat.nombre }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          {% if error %}
            <div class="alert alert-danger mt-3 mb-0 py-2 small">
              {{ error }}
            </div>
          {% endif %}
        </div>

        <!-- Footer -->
        <div class="modal-footer border-0 pt-0">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">
            Cancelar
          </button>
          <button type="submit" class="btn-brand">
            Guardar medicamento
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}

<script>
  // Auto-submit de filtro al cambiar opci√≥n
  document.getElementById('filtro-select')?.addEventListener('change', function() {
    document.getElementById('filtro-form')?.submit();
  });
</script>

<script>
(() => {
  const $inp = document.getElementById('meds-search');
  const $box = document.getElementById('meds-results');
  if(!$inp || !$box) return;

  const debounce = (fn, ms=250) => { let t; return (...a)=>{clearTimeout(t); t=setTimeout(()=>fn(...a), ms);} };
  const strip = s => (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();

  let activeIndex = -1;
  const url = $inp.dataset.url || '/inventario/search/';

  function hideBox(){ $box.style.display='none'; $box.innerHTML=''; activeIndex=-1; $inp.setAttribute('aria-expanded','false'); }
  function showBox(){ if($box.innerHTML.trim()){ $box.style.display='block'; $inp.setAttribute('aria-expanded','true'); } }
  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

  function render(items){
    if(!items.length){ hideBox(); return; }
    $box.innerHTML = items.map((r,i)=> `
      <a id="opt-${i}" role="option" href="${r.url}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-start" data-idx="${i}">
        <div class="ms-2 me-auto">
          <div class="fw-semibold">
            <span class="badge rounded-pill bg-primary me-2">Medicamento</span>${escapeHtml(r.label)}
          </div>
          <small class="text-muted">${escapeHtml(r.sub || '')}</small>
        </div>
        ${r.extra ? `<span class="badge bg-light text-dark border">${escapeHtml(r.extra)}</span>` : ''}
      </a>
    `).join('');
    showBox();
  }

  // Filtro local sobre la tabla si la API falla
  function filterTableLocally(q){
    const tb = document.getElementById('tabla-meds');
    if(!tb) return;
    const qn = strip(q);
    tb.querySelectorAll('tbody tr').forEach(tr=>{
      const txt = strip(tr.textContent);
      tr.style.display = txt.includes(qn) ? '' : 'none';
    });
  }

  const doSearch = debounce(async (q) => {
    if(!q || q.trim().length < 2){ hideBox(); filterTableLocally(''); return; }
    try {
      const resp = await fetch(`${url}?q=${encodeURIComponent(q.trim())}`, {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });
      if(resp.status === 401) {
        filterTableLocally(q); hideBox(); return;
      }
      if(!resp.ok) throw new Error('HTTP '+resp.status);
      const data = await resp.json();
      const items = Array.isArray(data.results) ? data.results : [];
      if(items.length) render(items);
      else { hideBox(); filterTableLocally(q); }
    } catch(e){
      console.warn('meds-search fallback local', e);
      hideBox(); filterTableLocally(q);
    }
  });

  $inp.addEventListener('input', e => doSearch(e.target.value));
  $inp.addEventListener('focus', ()=> { if($box.innerHTML.trim()) showBox(); });

  document.addEventListener('click', (e)=> {
    if(!( $box.contains(e.target) || $inp.contains(e.target) )) hideBox();
  });

  // Teclas ‚Üë ‚Üì Enter Esc
  $inp.addEventListener('keydown', (e)=>{
    const links = [...$box.querySelectorAll('a.list-group-item')];
    if(!links.length) return;
    if(e.key === 'ArrowDown'){ e.preventDefault(); activeIndex = (activeIndex+1) % links.length; highlight(links); }
    if(e.key === 'ArrowUp'){ e.preventDefault(); activeIndex = (activeIndex-1+links.length) % links.length; highlight(links); }
    if(e.key === 'Enter'){ if(activeIndex>=0){ e.preventDefault(); links[activeIndex].click(); } }
    if(e.key === 'Escape'){ hideBox(); }
  });

  function highlight(links){
    links.forEach(a=>a.classList.remove('active'));
    if(activeIndex>=0 && links[activeIndex]) {
      links[activeIndex].classList.add('active');
      $inp.setAttribute('aria-activedescendant', `opt-${activeIndex}`);
      links[activeIndex].scrollIntoView({ block:'nearest' });
    }
  }
})();
</script>
<script>
  function setupSelectFilter(inputId, selectId) {
    const input  = document.getElementById(inputId);
    const select = document.getElementById(selectId);
    if (!input || !select) return;

    // Guardamos las opciones originales
    const originalOptions = Array.from(select.options);

    input.addEventListener('input', () => {
      const term = input.value.trim().toLowerCase();

      // Reseteamos el select
      select.innerHTML = '';
      originalOptions.forEach(opt => {
        if (!term || opt.text.toLowerCase().includes(term)) {
          select.appendChild(opt);
        }
      });

      // Mantener siempre una opci√≥n placeholder arriba si no hay t√©rmino
      if (!term && select.options.length > 0) {
        select.selectedIndex = 0;
      }
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    setupSelectFilter('buscar-proveedor', 'proveedor-select');
    setupSelectFilter('buscar-categoria', 'categoria-select');
  });
</script>

{% endblock %}
