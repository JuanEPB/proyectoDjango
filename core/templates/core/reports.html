{% extends "core/base.html" %}
{% load static %}

{% block title %}Reportes · Pharmacontrol{% endblock %}

{% block content %}

<!-- Appbar -->
<div class="appbar">
  <div class="crumbs">Análisis / <b>Reportes</b></div>
  <div class="spacer"></div>

  <div class="search">
    <i class="bi bi-calendar3"></i>
    <select id="rep-periodo"
            class="form-control form-control-sm"
            style="background:transparent;border:none;outline:none;">
      <option value="30">Últimos 30 días</option>
      <option value="90">Últimos 90 días</option>
      <option value="365">Último año</option>
    </select>
  </div>

  <div class="user">
    <div class="avatar"></div>
    <span class="text-muted-2">Sesión activa</span>
  </div>
</div>

<!-- Contenido principal -->
  <div class="page-header">
    <div>
      <div class="title">Reportes</div>
      <div class="subtitle">
        Reporte IA y métricas de ventas, con el último movimiento a la vista.
      </div>
    </div>
    <div class="filters">
      <button id="btn-refrescar" class="btn-ghost">
        <i class="bi bi-arrow-repeat"></i> Actualizar
      </button>
    </div>
  </div>

  <div class="cards-grid">
    <!-- Card 1: Reporte IA -->
    <div class="card span-8" id="card-ia">
      <h4>Reporte por IA</h4>
      <div class="text-muted-2" style="font-size:12px;margin-bottom:4px;">
        Vista embebida del reporte generado por la IA.
      </div>
      <iframe id="iframe-ia"
              src="https://chat.pharmacontrol.site/"
              style="width:100%;height:500px;border:none;border-radius:12px;background:transparent;">
      </iframe>
    </div>

    <!-- Card 2: Ventas -->
    <div class="card span-4" id="card-ventas">
      <h4>Ventas del periodo</h4>
      <div id="ventas-loading"
           class="skeleton"
           style="height:120px;border-radius:12px;">
      </div>

      <div id="ventas-content" style="display:none">
        <div class="kpi-grid"
             style="grid-template-columns:repeat(2,1fr);gap:10px;margin:0;">
          <div class="kpi badge-up">
            <div class="kpi-label">Total vendido</div>
            <div class="kpi-value" id="ven-total">$0</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">Tickets</div>
            <div class="kpi-value" id="ven-tickets">0</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">Promedio ticket</div>
            <div class="kpi-value" id="ven-prom">$0</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">Artículos</div>
            <div class="kpi-value" id="ven-items">0</div>
          </div>
        </div>

        <div class="chart-wrap" style="height:140px;margin-top:8px;">
          <canvas id="venChart"></canvas>
        </div>
      </div>
    </div>


    <!-- Card 3: Última venta -->
    <div class="card span-6">
      <h4>Última venta</h4>
      <div id="ult-venta-list" class="list-group mt-2">
        {% if ultimas_ventas %}
          {% for venta in ultimas_ventas|slice:":5" %} {# Mostramos las últimas 5 ventas #}
            <div class="list-group-item d-flex justify-content-between align-items-center">
              <span>
                <strong>{{ venta.folio|default:venta.doc_id }}</strong>
                <small class="text-muted ms-1">
                  {% if venta.createdAt %}
                    {{ venta.createdAt|date:"Y-m-d H:i" }}
                  {% elif venta.fecha %}
                    {{ venta.fecha|date:"Y-m-d H:i" }}
                  {% endif %}
                </small>
              </span>
              <div class="btn-group btn-group-sm">
                {% if venta.doc_id %}
                  <a class="btn btn-ghost" href="{% url 'doc_descargar_pdf' venta.doc_id %}">
                    <i class="bi bi-receipt"></i> Descargar ticket
                  </a>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="text-muted-2 small p-2">No hay ventas recientes para mostrar.</div>
        {% endif %}
      </div>
    </div>

    <!-- Card 4: Últimos reportes IA -->
    <div class="card span-6">
      <h4>Últimos reportes IA (PDF)</h4>
      <div id="ultimos-ia-list" class="list-group mt-2">
        {% if reportes_ia %}
          {% for reporte in reportes_ia|slice:":5" %} {# Mostramos los últimos 5 reportes #}
            <div class="list-group-item d-flex justify-content-between align-items-center">
              <span>
                <strong>{{ reporte.titulo|default:reporte.descripcion|default:"Reporte IA" }}</strong>
                <small class="text-muted ms-1">{{ reporte.createdAt|date:"Y-m-d" }}</small>
              </span>
              {% if reporte.doc_id %}
                <a class="btn btn-sm btn-ghost" href="{% url 'doc_descargar_pdf' reporte.doc_id %}">
                  <i class="bi bi-file-earmark-pdf"></i> Descargar
                </a>
              {% endif %}
            </div>
          {% endfor %}
        {% else %}
          <div class="text-muted-2 small p-2">No hay reportes de IA para mostrar.</div>
        {% endif %}
      </div>
    </div>
  </div>

<!-- Scripts específicos de esta página -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="{% static 'js/dashboard.js' %}?v=5"></script>
<script>
  (function boot(){
    const run = () => window.initReportsPage && window.initReportsPage();
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', run);
    } else {
      run();
    }
  })();
</script>

{% endblock %}
